on("chat:message", function(msg){
   
  if( msg.type == "api" && msg.content.indexOf("!í–ˆë„¤í–ˆì–´") !== -1 ){
      
      var cutie = findObjs({type: 'character', name: msg.who})[0],
          cutieIs = cutie.get('name'),
          cutieId = cutie.get('id'),
          allCuties = findObjs({ type: 'character'}),
          theContent = parseInt(msg.content.replace("!í–ˆë„¤í–ˆì–´ ", "")),
          lovelyOne = allCuties.find(function(obj) {
        
        var theOne = obj.get('name');
        return theOne !== msg.who;
        
        });
    
     var lovelyOneIs = lovelyOne.get('name');
     
     if( theContent >= 1 && theContent <= 4 ){
         
         sendChat( cutieIs, "/r d200cs<1<@{"+ msg.who + "|" + lovelyOneIs + "ì—ê²Œ ëŠë¼ëŠ” ëŒë¦¼}", function(ops){
            
                rolling(msg, ops);
                    
                });
            }

     
     else if( theContent >= 5 && theContent <= 8 ){
         
         sendChat( cutieIs, "/r d250cs<1<@{"+ msg.who + "|" + lovelyOneIs + "ì—ê²Œ ëŠë¼ëŠ” ëŒë¦¼}", function(ops){
            
                rolling(msg, ops);
                
                });
            }

     
     else if( theContent >= 9 && theContent <= 12 ){
         
         sendChat( cutieIs, "/r d300cf>300cs<1<@{"+ msg.who + "|" + lovelyOneIs + "ì—ê²Œ ëŠë¼ëŠ” ëŒë¦¼}", function(ops){

                rolling(msg, ops);  

                });
            }
   
    }
});

function rolling (msg, ops) {
    
      var cutie = findObjs({type: 'character', name: msg.who})[0],
      cutieIs = cutie.get('name'),
      cutieId = cutie.get('id'),
      allCuties = findObjs({ type: 'character'}),
      theContent = parseInt(msg.content.replace("!í–ˆë„¤í–ˆì–´ ", "")),
      lovelyOne = allCuties.find(function(obj) {
    
    var theOne = obj.get('name');
    return theOne !== msg.who;
    
    });
    
     var lovelyOneIs = lovelyOne.get('name');
    
    var rollresult = JSON.parse(ops[0].content),
        theResult = parseInt(rollresult.rolls[0].results[0].v),
        theTotal = rollresult.total,
        PF = " ",
        bigHit = 1;
        
        
    if ( theTotal == 1 ){
        
        PF = "í¥ë¶„í•©ë‹ˆë‹¤.";
        if ( theResult == 1 ){
            
            PF = "êµ‰ì¥íˆ í¥ë¶„í•©ë‹ˆë‹¤.";
            bigHit = 2;
            
        }
        
    }
    else {
        
        PF = "í¥ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        if ( theResult == 251 ){
            
            PF = "ë¶ˆì¾Œê°ì„ ëŠë‚ë‹ˆë‹¤.";
            bigHit = 2;
            
        }
    }
    
    var guilt = findObjs({type: 'attribute', name: 'ì£„ì±…ê°', characterid: cutie.id})[0],
        guiltIs = parseInt(guilt.get('current')),
        attraction = findObjs({type: 'attribute', name: lovelyOneIs + 'ì—ê²Œ ëŠë¼ëŠ” ëŒë¦¼', characterid: cutie.id})[0],
        attractionIs = parseInt(attraction.get('current')),
        faith = findObjs({type: 'attribute', name: 'ì‹ ì•™ì‹¬', characterid: cutie.id})[0],
        faithIs = parseInt(faith.get('current')),
        immorality = findObjs({type: 'attribute', name: 'ë°°ë•ê°', characterid: cutie.id})[0],
        immoralityIs = parseInt(immorality.get('current')),
        hardheaded = findObjs({type: 'attribute', name: 'ë³´ìˆ˜ì  ê²½í–¥', characterid: cutie.id})[0],
        guiltFinal = guiltIs + ( faithIs * theContent ),
        attractionFinal = attractionIs + ( theTotal * theContent * immoralityIs * bigHit ) + ( (theTotal-1) * theContent * bigHit * bigHit * 2 );
        faithFinal = faithIs - 1;
        arroused = theTotal * theContent * immoralityIs * bigHit;
    
    if ( guiltFinal > 250 ){
        
        guiltFinal = 250
        
    }
    
    if ( guiltFinal < 1 ){
        
        guiltFinal = 1
        
    }
    
    if ( attractionFinal > 250 ){
        
        attractionFinal = 250
        
    }
    
    if ( attractionFinal < 1 ){
        
        attractionFinal = 1
        
    }
    
    attraction.set('current', attractionFinal);
    guilt.set('current', guiltFinal);

    sendChat( "character|" + cutieId, "/em ì˜ " + lovelyOneIs + "ì„(ë¥¼) í–¥í•œ ëŒë¦¼ì€ [[" + attractionIs + "]], ì£¼ì‚¬ìœ„ì˜ ê²°ê³¼ëŠ” [[" + theResult + "]].\n/em ì€(ëŠ”) " + PF + "\n/em ì´(ê°€) " + lovelyOneIs + "ì—ê²Œ ëŠë¼ëŠ” ëŒë¦¼ì€ [[" + attractionFinal + "]]ì´(ê°€) ë˜ì—ˆìŠµë‹ˆë‹¤.\n/em ì´(ê°€) ëŠë¼ëŠ” ì£„ì±…ê°ì€ [[" + guiltFinal + "]]ì´(ê°€) ë˜ì—ˆìŠµë‹ˆë‹¤.\n!ëŒë¦¼ë°”ë€œ");
    
    if( theTotal == 0 ){
        sendChat( "character|" + cutieId, "!ì£„ì±…ê°ë°”ë€œ");
    }
    
    else if ( theTotal == 1 && arroused < 40 ){
        
        sendChat( "character|" + cutieId, "!ì£„ì±…ê°ë°”ë€œ");
    }
    
    else if ( arroused >= 40 ){
        
        sendChat( "", "/desc ğŸ’’ ì•—...! ğŸ’’ \n/desc ğŸ’’ " + cutieIs + "ì€(ëŠ”) ë™ì„±ê°„ í–‰ìœ„ì— ëª¹ì‹œ í¥ë¶„í•œ ë‚˜ë¨¸ì§€ ì‹ ì•™ì‹¬ì´ í”ë“¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤. ğŸ’’ \n/desc ğŸ’’ " + cutieIs + "ì˜ ë³´ìˆ˜ì ì¸ ë§ˆìŒì´ ì‹ ì•™ì‹¬ì„ ì§€ì¼œë³´ë ¤ í•©ë‹ˆë‹¤. ğŸ’’");
        sendChat( "character|" + cutieId, "[ì‹ ì•™ì‹¬ í”ë“¤](!ì‹ ì•™ì‹¬í”ë“¤)");
            
    }
    
    
}
